<% content_for :head do -%>
  <%= stylesheet_link_tag 'tables.css' %>
<% end %>

<% content_for :below_body do -%>
  <%= javascript_include_tag 'validators.js' %>
  <% if Settings.allow_preorders %>
    <%= javascript_include_tag 'shopping/preorder_checkout.js' %>
  <% else %>
    <%= javascript_include_tag 'shopping/checkout.js' %>
  <% end %>
<% end %>

<div id='order-wrapper' class='twelve'>
  <div class='seven columns'>
    <h1>Order Summary</h1>

    <div id='order-items-summary'>
      <% i = 1 %>
      <% @order.order_items.group_by(&:variant_id).each do |variant_id, items| %>
        <div id='order-item-<%= i %>' class='panel'>
          <%= render :partial => 'order_item', :locals => {:items => items } %>
        </div>
        <% i += 1 %>
      <% end %>
    </div>

    <div id='final-order-shipping-address' class='panel four large-4 columns radius' >
      <h5>Shipping Address</h5>
      <%= render :partial => '/shared/compact_address', :locals => {:shopping_address => @order.ship_address} %>
      <%= link_to 'Change address', shopping_addresses_path, :class => 'button tiny green' %>
    </div>
    <div id='final-order-shipping-address' class='panel four large-4 columns radius last' >
      <h5>Billing Address</h5>
      <%= render :partial => '/shared/compact_address', :locals => {:shopping_address => @order.bill_address} %>
    </div>
  </div>
  <div class='pretty_table five large-5 columns last'>
    <table>
      <thead>
        <tr class='odd'>
          <th class='column1_header'>
            Item
          </th><th>Price:</th><th>Price + Tax</th>
        </tr>
      </thead>
      <% @order.order_items.each do |item| %>
        <tr class='<%= cycle("odd", "")%> '>
          <td><%= item.variant.product.name %></td><td><%= number_to_currency item.price %></td><td><%= number_to_currency item.total %></td>
        </tr>
      <% end %>
      <tr class='odd'>
        <td></td><td>Sub-total:</td><td><%= number_to_currency @order.sub_total %></td>
      </tr>
      <tr>
        <td></td><td>Shipping Charges:</td><td><%= number_to_currency @order.shipping_charges %></td>
      </tr>
      <% if @order.coupon_amount > 0.0 %>
        <tr>
          <td></td><td>Coupon:</td><td><%= number_to_currency @order.coupon_amount %></td>
        </tr>
      <% end %>
      <% if @order.deal_amount && @order.deal_amount > 0.0 %>
        <tr>
          <td></td><td>Promotion:</td><td><%= number_to_currency @order.deal_amount %></td><td></td>
        </tr>
      <% end %>
      <tr>
        <td></td><td>Tax:</td><td><%= number_to_currency @order.taxed_amount %></td>
      </tr>
      <% if @order.amount_to_credit && @order.amount_to_credit > 0.0 %>
        <tr class='odd'>
          <td></td>
          <td>Credits:</td><td></td>
          <td><%= number_to_currency @order.amount_to_credit %></td>
        </tr>
      <% end %>

      <tfoot>
        <tr class='even'>
          <td></td><td>Total:</td>
          <td id='credited_total' data-integer_credited_total='<%= @order.integer_credited_total %>'>
            <em><%= number_to_currency @order.credited_total %></em>
          </td>
        </tr>
      </tfoot>
    </table>
    <div>
  </div>

    <%= form_tag( (Settings.allow_preorders ? preorder_shopping_order_path(@order) : shopping_order_path(@order)),
                                  :method => :put,
                                  :id   => 'purchase_cart_order') do  %>

        <% if @payment_profiles.present? %>
          <div class='panel clearfix'>
            <% @payment_profiles.each do |payment_method| %>
              <div id='card_on_file' class="field column ar-use-saved-card  last" style='width:425px'>
                <h5> Use Credit Card on file? </h5>
                <%= radio_button_tag(:use_credit_card_on_file, payment_method.id, false) %>
                <%= payment_method.cc_type %> - <%= payment_method.last4 %>
                (<%= payment_method.month %>/<%= payment_method.year %>)
                <div style='margin-top:10px;'>
                <%= link_to 'Use Card and Complete Order', '#use-card-on-file-button',
                                :id     => 'use-card-on-file-button',
                                :class  => 'button small success cart-submit-button' %>
                </div>
              </div>
            <% end %>
          </div>
          <div id='card_not_on_file' class="field column ar-use-saved-card last" style='width:425px'>
            <%= radio_button_tag(:use_credit_card_on_file, 0, true) %> Use New Card.
          </div>
        <% end %>
      <div class='payment-errors' style='display:none;color:#d06050;font-weight:bold;'></div>

<div class='clear'></div>
      <div class="field twelve large-12 column">
        <%= label_tag :name %>
         <%= text_field_tag(:full_name, '') %>
      </div>

      <div class='clear'></div>
      <div class="field twelve large-12 column">
        <%= label_tag 'Number'%> <%= '4242424242424242' if Rails.env != 'production' %>
         <%= text_field_tag(:number, '' ,:class => ' disableAutoComplete', :autocomplete => "off", name: nil) %>
         <%= hidden_field_tag('stripe_card_token', nil) %>
         <%= hidden_field_tag('token_amount', nil) %>
      </div>
      <div class='twelve clearfix'>
        <div class="field three column">
          <%= label_tag :verification_value, 'VCC'%>
           <%= text_field_tag(:verification_value, '' ,:class => 'disableAutoComplete', :autocomplete => "off", name: nil) %>
        </div>

        <div class="field column ">
          <%= label_tag :brand, 'Type'%>
           <%= select_tag(:brand, options_for_select(['visa', 'mastercard', 'discover', 'American Express'])) %>
        </div>

        <div class="field column">
          <%= label_tag :month %>
          <%= select_tag(:month, options_for_select(['01', '02',  '03', '04', '05', '06', '07', '08', '09', '10', '11', '12' ])) %>
        </div>

        <div class="field column" style='padding-right:10px;'>
          <%= label_tag :year %>
           <%= select_tag(:year, options_for_select((Time.zone.now.year..(Time.zone.now.year + 12)))) %>
        </div>
      </div>

      <div class="field column float-left">
        <%= label_tag :save_card %>
         <%= check_box_tag(:save_card, 1) %>
      </div>


      <%= submit_tag 'Complete Order', :class => 'button success cart-submit-button' %>
    <% end %>
  </div>
</div>
